<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg viewBox="0 0 780 620" width="206mm" height="164mm" version="1.1"
   xmlns:xlink="http://www.w3.org/1999/xlink"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
  <defs>
    <!-- Premium Gradients -->
    <linearGradient id="bgGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#fafbfc" />
      <stop offset="100%" stop-color="#f1f5f9" />
    </linearGradient>
    
    <linearGradient id="rank0Grad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#f59e0b" />
      <stop offset="100%" stop-color="#d97706" />
    </linearGradient>
    
    <linearGradient id="rankGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#0ea5e9" />
      <stop offset="100%" stop-color="#0284c7" />
    </linearGradient>
    
    <linearGradient id="trainGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#22c55e" />
      <stop offset="100%" stop-color="#16a34a" />
    </linearGradient>
    
    <linearGradient id="backwardGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#14b8a6" />
      <stop offset="100%" stop-color="#0d9488" />
    </linearGradient>
    
    <linearGradient id="syncGrad" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#8b5cf6" />
      <stop offset="100%" stop-color="#7c3aed" />
    </linearGradient>
    
    <linearGradient id="decisionGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#fbbf24" />
      <stop offset="100%" stop-color="#f59e0b" />
    </linearGradient>
    
    <linearGradient id="broadcastGrad" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#f87171" />
      <stop offset="100%" stop-color="#ef4444" />
    </linearGradient>
    
    <linearGradient id="stopGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#ef4444" />
      <stop offset="100%" stop-color="#dc2626" />
    </linearGradient>
    
    <linearGradient id="cardGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#ffffff" />
      <stop offset="100%" stop-color="#f8fafc" />
    </linearGradient>
    
    <!-- Arrow Markers -->
    <marker id="arrowGray" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto" markerUnits="strokeWidth">
      <path d="M0,1 L9,4 L0,7 L2,4 Z" fill="#64748b" />
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto" markerUnits="strokeWidth">
      <path d="M0,1 L9,4 L0,7 L2,4 Z" fill="#dc2626" />
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto" markerUnits="strokeWidth">
      <path d="M0,1 L9,4 L0,7 L2,4 Z" fill="#7c3aed" />
    </marker>
  </defs>
  
  <!-- Premium Background -->
  <rect x="0" y="0" width="780" height="620" fill="url(#bgGrad)" />
  
  <!-- Decorative background elements -->
  <circle cx="700" cy="100" r="130" fill="#8b5cf6" fill-opacity="0.03" />
  <circle cx="80" cy="550" r="100" fill="#ef4444" fill-opacity="0.03" />
  <circle cx="400" cy="320" r="200" fill="#22c55e" fill-opacity="0.02" />
  
  <!-- ==================== HEADER ==================== -->
  <g transform="translate(390, 35)">
    <text x="0" y="0" font-family="Arial, sans-serif" font-size="22" font-weight="bold" fill="#0f172a" text-anchor="middle" letter-spacing="0.5">DDP-Safe Early Stopping Protocol</text>
    <text x="0" y="22" font-family="Arial, sans-serif" font-size="11" fill="#64748b" text-anchor="middle">Synchronized Termination Across All GPU Ranks</text>
    <line x1="-130" y1="32" x2="130" y2="32" stroke="#e2e8f0" stroke-width="2" stroke-linecap="round"/>
  </g>
  
  <!-- ==================== TIMELINE ARROW ==================== -->
  <g transform="translate(45, 90)">
    <line x1="0" y1="0" x2="0" y2="460" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrowGray)" />
    <text x="-15" y="230" font-family="Arial, sans-serif" font-size="10" fill="#64748b" text-anchor="middle" transform="rotate(-90, -15, 230)">time</text>
    
    <!-- Epoch markers -->
    <rect x="-35" y="20" width="60" height="22" rx="11" fill="#f1f5f9" stroke="#e2e8f0" stroke-width="1"/>
    <text x="-5" y="35" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#475569" text-anchor="middle">Epoch N</text>
    
    <rect x="-35" y="405" width="60" height="22" rx="11" fill="#fef2f2" stroke="#fca5a5" stroke-width="1"/>
    <text x="-5" y="420" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#dc2626" text-anchor="middle">Exit</text>
  </g>
  
  <!-- ==================== RANK HEADERS ==================== -->
  <g transform="translate(120, 75)">
    <!-- Rank 0 (Main) -->
    <rect x="0" y="0" width="130" height="35" rx="10" fill="url(#rank0Grad)" />
    <text x="65" y="15" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#ffffff" text-anchor="middle">Rank 0</text>
    <text x="65" y="28" font-family="Arial, sans-serif" font-size="9" fill="#fef3c7" text-anchor="middle">(Main Process)</text>
    
    <!-- Rank 1 -->
    <rect x="155" y="0" width="100" height="35" rx="10" fill="url(#rankGrad)" />
    <text x="205" y="22" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#ffffff" text-anchor="middle">Rank 1</text>
    
    <!-- Rank 2 -->
    <rect x="280" y="0" width="100" height="35" rx="10" fill="url(#rankGrad)" />
    <text x="330" y="22" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#ffffff" text-anchor="middle">Rank 2</text>
    
    <!-- Rank N -->
    <rect x="405" y="0" width="100" height="35" rx="10" fill="url(#rankGrad)" />
    <text x="455" y="22" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#ffffff" text-anchor="middle">Rank N</text>
  </g>
  
  <!-- Timeline lines for each rank -->
  <g stroke="#cbd5e1" stroke-width="1.5" stroke-dasharray="4,4">
    <line x1="185" y1="115" x2="185" y2="520" />
    <line x1="325" y1="115" x2="325" y2="520" />
    <line x1="450" y1="115" x2="450" y2="520" />
    <line x1="575" y1="115" x2="575" y2="520" />
  </g>
  
  <!-- ==================== PHASE 1: FORWARD PASS ==================== -->
  <g transform="translate(120, 130)">
    <rect x="0" y="0" width="120" height="40" rx="6" fill="url(#trainGrad)" />
    <text x="60" y="15" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Forward</text>
    <text x="60" y="30" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Pass</text>
  </g>
  <g transform="translate(270, 130)">
    <rect x="0" y="0" width="110" height="40" rx="6" fill="url(#trainGrad)" />
    <text x="55" y="15" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Forward</text>
    <text x="55" y="30" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Pass</text>
  </g>
  <g transform="translate(395, 130)">
    <rect x="0" y="0" width="110" height="40" rx="6" fill="url(#trainGrad)" />
    <text x="55" y="15" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Forward</text>
    <text x="55" y="30" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Pass</text>
  </g>
  <g transform="translate(520, 130)">
    <rect x="0" y="0" width="110" height="40" rx="6" fill="url(#trainGrad)" />
    <text x="55" y="15" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Forward</text>
    <text x="55" y="30" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Pass</text>
  </g>
  
  <!-- Connecting arrows -->
  <path d="M240,150 L265,150" stroke="#64748b" stroke-width="1.5" fill="none" marker-end="url(#arrowGray)" />
  <path d="M380,150 L390,150" stroke="#64748b" stroke-width="1.5" fill="none" marker-end="url(#arrowGray)" />
  <path d="M505,150 L515,150" stroke="#64748b" stroke-width="1.5" fill="none" marker-end="url(#arrowGray)" />
  
  <!-- ==================== PHASE 2: BACKWARD PASS ==================== -->
  <g transform="translate(120, 185)">
    <rect x="0" y="0" width="120" height="40" rx="6" fill="url(#backwardGrad)" />
    <text x="60" y="15" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Backward</text>
    <text x="60" y="30" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Pass</text>
  </g>
  <g transform="translate(270, 185)">
    <rect x="0" y="0" width="110" height="40" rx="6" fill="url(#backwardGrad)" />
    <text x="55" y="15" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Backward</text>
    <text x="55" y="30" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Pass</text>
  </g>
  <g transform="translate(395, 185)">
    <rect x="0" y="0" width="110" height="40" rx="6" fill="url(#backwardGrad)" />
    <text x="55" y="15" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Backward</text>
    <text x="55" y="30" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Pass</text>
  </g>
  <g transform="translate(520, 185)">
    <rect x="0" y="0" width="110" height="40" rx="6" fill="url(#backwardGrad)" />
    <text x="55" y="15" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Backward</text>
    <text x="55" y="30" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Pass</text>
  </g>
  
  <!-- ==================== PHASE 3: ALL-REDUCE GRADIENTS ==================== -->
  <g transform="translate(115, 245)">
    <rect x="2" y="2" width="526" height="32" rx="8" fill="#94a3b8" fill-opacity="0.15" />
    <rect x="0" y="0" width="526" height="32" rx="8" fill="url(#syncGrad)" />
    
    <!-- Sync arrows icon -->
    <g transform="translate(15, 8)">
      <path d="M0,8 L10,8" stroke="#ffffff" stroke-width="2" stroke-linecap="round" />
      <path d="M7,5 L10,8 L7,11" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    </g>
    
    <text x="263" y="21" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#ffffff" text-anchor="middle">All-Reduce Gradients (DDP Sync Point)</text>
    
    <!-- Sync arrows icon right -->
    <g transform="translate(496, 8)">
      <path d="M10,8 L0,8" stroke="#ffffff" stroke-width="2" stroke-linecap="round" />
      <path d="M3,5 L0,8 L3,11" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    </g>
  </g>
  
  <!-- ==================== PHASE 4: VALIDATION + DECISION (Rank 0 Only) ==================== -->
  <g transform="translate(120, 295)">
    <!-- Container for Rank 0 only -->
    <rect x="0" y="0" width="120" height="48" rx="6" fill="url(#decisionGrad)" stroke="#d97706" stroke-width="1.5" />
    <text x="60" y="18" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="#78350f" text-anchor="middle">Compute</text>
    <text x="60" y="32" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="#78350f" text-anchor="middle">Validation Loss</text>
    <text x="60" y="44" font-family="Consolas, monospace" font-size="7" fill="#92400e" text-anchor="middle">patience_ctr++</text>
  </g>
  
  <!-- Decision box -->
  <g transform="translate(120, 355)">
    <rect x="0" y="0" width="120" height="48" rx="6" fill="#fef2f2" stroke="#fca5a5" stroke-width="1.5" />
    
    <!-- Warning triangle -->
    <g transform="translate(15, 12)">
      <polygon points="10,0 20,18 0,18" fill="#ef4444" />
      <line x1="10" y1="5" x2="10" y2="11" stroke="#ffffff" stroke-width="2" stroke-linecap="round" />
      <circle cx="10" cy="14" r="1.5" fill="#ffffff" />
    </g>
    
    <text x="75" y="18" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="#dc2626" text-anchor="middle">Decision:</text>
    <text x="75" y="32" font-family="Consolas, monospace" font-size="7" fill="#b91c1c" text-anchor="middle">patience_ctr</text>
    <text x="75" y="43" font-family="Consolas, monospace" font-size="7" fill="#b91c1c" text-anchor="middle">&gt;= patience</text>
  </g>
  
  <!-- ==================== PHASE 5: BROADCAST STOP SIGNAL ==================== -->
  <g transform="translate(115, 420)">
    <rect x="2" y="2" width="526" height="38" rx="8" fill="#94a3b8" fill-opacity="0.15" />
    <rect x="0" y="0" width="526" height="38" rx="8" fill="none" stroke="url(#broadcastGrad)" stroke-width="2.5" stroke-dasharray="8,4" />
    
    <rect x="130" y="7" width="266" height="24" rx="12" fill="url(#broadcastGrad)" />
    <text x="263" y="24" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#ffffff" text-anchor="middle">broadcast_early_stop(should_stop)</text>
    
    <!-- Broadcast arrows -->
    <path d="M120,19 L135,19" stroke="#ef4444" stroke-width="2" fill="none" marker-end="url(#arrowRed)" />
    <path d="M396,19 L510,19" stroke="#ef4444" stroke-width="2" fill="none" marker-end="url(#arrowRed)" />
  </g>
  
  <!-- ==================== PHASE 6: SYNCHRONIZED EXIT ==================== -->
  <g transform="translate(120, 478)">
    <rect x="0" y="0" width="120" height="40" rx="6" fill="url(#stopGrad)" />
    <text x="60" y="18" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Synchronized</text>
    <text x="60" y="32" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Exit</text>
  </g>
  <g transform="translate(270, 478)">
    <rect x="0" y="0" width="110" height="40" rx="6" fill="url(#stopGrad)" />
    <text x="55" y="18" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Synchronized</text>
    <text x="55" y="32" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Exit</text>
  </g>
  <g transform="translate(395, 478)">
    <rect x="0" y="0" width="110" height="40" rx="6" fill="url(#stopGrad)" />
    <text x="55" y="18" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Synchronized</text>
    <text x="55" y="32" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Exit</text>
  </g>
  <g transform="translate(520, 478)">
    <rect x="0" y="0" width="110" height="40" rx="6" fill="url(#stopGrad)" />
    <text x="55" y="18" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Synchronized</text>
    <text x="55" y="32" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#ffffff" text-anchor="middle">Exit</text>
  </g>
  
  <!-- Connecting bracket -->
  <path d="M120,530 L120,540 L630,540 L630,530" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" />
  <circle cx="375" cy="540" r="4" fill="#dc2626" />
  
  <!-- ==================== EXPLANATION BOX ==================== -->
  <g transform="translate(650, 285)">
    <rect x="2" y="2" width="115" height="125" rx="10" fill="#94a3b8" fill-opacity="0.15" />
    <rect x="0" y="0" width="115" height="125" rx="10" fill="url(#cardGrad)" stroke="#e2e8f0" stroke-width="1.5" />
    
    <text x="57.5" y="18" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#334155" text-anchor="middle">Key Insight</text>
    <line x1="15" y1="28" x2="100" y2="28" stroke="#e2e8f0" stroke-width="1" />
    
    <text x="10" y="45" font-family="Arial, sans-serif" font-size="8" fill="#475569">Only Rank 0</text>
    <text x="10" y="58" font-family="Arial, sans-serif" font-size="8" fill="#475569">tracks patience.</text>
    
    <text x="10" y="78" font-family="Arial, sans-serif" font-size="8" fill="#475569">Other ranks</text>
    <text x="10" y="91" font-family="Arial, sans-serif" font-size="8" fill="#475569">receive signal</text>
    <text x="10" y="104" font-family="Arial, sans-serif" font-size="8" fill="#475569">via broadcast.</text>
    
    <text x="57.5" y="120" font-family="Consolas, monospace" font-size="7" fill="#7c3aed" text-anchor="middle">dist.broadcast()</text>
  </g>
  
  <!-- ==================== FOOTER: Benefits ==================== -->
  <g transform="translate(60, 565)">
    <rect x="2" y="2" width="660" height="42" rx="10" fill="#94a3b8" fill-opacity="0.1" />
    <rect x="0" y="0" width="660" height="42" rx="10" fill="#ffffff" stroke="#e2e8f0" stroke-width="1"/>
    
    <!-- Checkmark icon -->
    <circle cx="30" cy="21" r="14" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5" />
    <path d="M23,21 L28,26 L37,16" fill="none" stroke="#16a34a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
    
    <text x="55" y="18" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#166534">Prevents Deadlock:</text>
    <text x="55" y="32" font-family="Arial, sans-serif" font-size="9" fill="#475569">Without broadcast, only Rank 0 exits, leaving other ranks waiting indefinitely for gradient sync.</text>
    
    <!-- Exit icon -->
    <g transform="translate(610, 7)">
      <rect x="0" y="0" width="38" height="28" rx="6" fill="#fef2f2" stroke="#fca5a5" stroke-width="1" />
      <path d="M12,14 L26,14" stroke="#dc2626" stroke-width="2" stroke-linecap="round" />
      <path d="M22,10 L26,14 L22,18" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      <rect x="8" y="8" width="8" height="12" rx="1" fill="none" stroke="#dc2626" stroke-width="1.5" />
    </g>
  </g>
</svg>
